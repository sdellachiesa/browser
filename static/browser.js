// Copyright 2019 Eurac Research. All rights reserved.
// Use of this source code is governed by the Apache 2.0
// license that can be found in the LICENSE file.

// browser sets up the client for filtering and downloading LTER data.
// opts is an object with these keys data - JSON data object
//	stationEl - stations select element
//	measurementEl - measurements select element
//	landuseEl - landuse select element
//	elevationEl - elevation range element
//	dateEl - date picker element
//	sDateEl - start date element
//	eDateEl - end date element
//	submitEl - submit button element
//	codeEl - code button element
//	dlMapAreaEl - area for download links on the map
//	mapEl - map element
//	scrollToTopEl - element for scrolling back to top
function browser(opts) {
	const mapMarkers = {};
	const maxMeasurement = 30;

	function getMaxElevation() {
		let a = 0;

		opts.data.forEach(function(s) {
			if (s.Elevation >= a) {
				a = s.Elevation
			}
		});

		return Math.round(a/1000)*1000;
	}

	function getMinElevation() {
		let a = 10000;

		opts.data.forEach(function(s) {
			if (s.Elevation <= a) {
				a = s.Elevation
			}
		});

		return Math.floor(a/100)*100;
	}

	function loadMap() {
		const map = L.map(opts.mapEl, {zoomControl: false}).setView([46.69765764825818, 10.638368502259254], 13);

		const basemap = {
		"Orthophotos South Tyrol (2014/2015/2017)": L.tileLayer.wms('https://geoservices.buergernetz.bz.it/geoserver/ows?', {
			layers: 'P_BZ_OF_2014_2015_2017',
			attribution: 'Map data &copy; <a href="http://geoportal.buergernetz.bz.it/geodaten.asp">Geoportal SÃ¼dtirol</a>, <a href="https://creativecommons.org/publicdomain/zero/1.0/deed.en">CC-0</a>'
		}).addTo(map),

		"Open Street Map": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png?', {
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>'}),

		"OpenTopoMap": L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
		attribution: 'Kartendaten: &copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap</a>-Mitwirkende, SRTM | Kartendarstellung: &copy; <a href="http://opentopomap.org/">OpenTopoMap<a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'}),

		"Google Maps Terrain": L.tileLayer('http://{s}.google.com/vt/lyrs=p&x={x}&y={y}&z={z}',{
			maxZoom: 20,
			subdomains:['mt0','mt1','mt2','mt3'],
			attribution: 'Map data &copy; Google.'})
		}

		const longlat = L.GeoJSON.coordsToLatLngs([[10.720305866000047,46.79949289100006],[10.720139355000072,46.799639384000045],[10.720117365000021,46.79968022600008],[10.71993907500007,46.80001136700008],[10.719906439000056,46.80034933200005],[10.719773395000061,46.800288942000066],[10.719589792000022,46.80020560200006],[10.719223352000029,46.80006712000005],[10.718500917000028,46.79983499000008],[10.71833397000006,46.79978800100008],[10.717668254000046,46.79961351000003],[10.717377793000026,46.79954587600008],[10.716786207000041,46.799487258000056],[10.716137682000067,46.799492487000066],[10.715738173000034,46.79949847900008],[10.715056472000072,46.799490700000035],[10.714772549000031,46.79960294700004],[10.714139978000048,46.79969791900004],[10.71370812300006,46.79979438100003],[10.713183688000072,46.799941724000064],[10.713042091000034,46.79999700900004],[10.712991946000045,46.80001658900005],[10.71266885600005,46.800030425000045],[10.712260269000069,46.80008603600004],[10.71162804100004,46.800140492000025],[10.711581464000062,46.80014383200006],[10.711328423000054,46.80016198100003],[10.711310965000052,46.800163233000035],[10.71062897400003,46.80024992500006],[10.71024469100007,46.80029910600007],[10.710230885000044,46.800300873000026],[10.710087748000035,46.800292495000065],[10.70963712200006,46.80026612200004],[10.709557182000026,46.80026144400006],[10.708690948000026,46.80022038700008],[10.70801788500006,46.80014944200008],[10.707718357000033,46.80013141400008],[10.707001552000065,46.80010161300004],[10.705587198000046,46.80005521000004],[10.705379521000054,46.79972983000005],[10.70489742600006,46.79917005600004],[10.704474341000036,46.798870382000075],[10.703924585000038,46.79852759700003],[10.703675949000058,46.79827931800003],[10.703492873000073,46.79808405800003],[10.703284311000061,46.79791167600007],[10.703068230000042,46.79783839800007],[10.702535741000077,46.797652837000044],[10.702212279000037,46.79757665600005],[10.701988757000038,46.79755298300006],[10.701538612000036,46.797537179000074],[10.701476351000053,46.79752987000006],[10.70109634000005,46.79748526000003],[10.700663545000054,46.79737020200008],[10.700097252000035,46.79720313100006],[10.699970174000043,46.797043031000044],[10.699952930000052,46.79701770300005],[10.699827622000043,46.796833665000065],[10.699633640000059,46.79662956200008],[10.69944014500004,46.79649294600006],[10.699240072000066,46.79632943000007],[10.698939279000058,46.79614041100007],[10.698587846000066,46.79592964500006],[10.698195594000026,46.79569698500006],[10.697603927000046,46.79563377000005],[10.697499396000069,46.795617322000055],[10.696995859000026,46.79554379700005],[10.696587907000037,46.79554084700004],[10.696386833000076,46.79544933600005],[10.696128116000068,46.79529568300006],[10.695668843000021,46.79514500200003],[10.695426867000037,46.79495060200003],[10.69507412300004,46.79464535100004],[10.694738689000076,46.79431734500008],[10.694361903000072,46.79397645100005],[10.694159935000073,46.793803954000055],[10.693701327000042,46.793491267000036],[10.693322946000023,46.79317739100003],[10.693140010000036,46.79306310700008],[10.692805467000028,46.79291956800006],[10.692295104000038,46.79297292600006],[10.691881078000051,46.793015756000045],[10.691666926000039,46.79284443500006],[10.691367114000059,46.79263028400004],[10.691110132000063,46.79268739100007],[10.690681829000027,46.792715944000065],[10.690096482000058,46.79284443500006],[10.689231798000037,46.79250891700008],[10.688701097000035,46.792665240000076],[10.68811187700004,46.79283592200005],[10.687829239000052,46.79288508900004],[10.687630772000034,46.79292851300005],[10.687478043000056,46.79293221200004],[10.687156137000045,46.79294001200003],[10.68688095500005,46.792939570000044],[10.68643406600006,46.792971657000066],[10.68625013600007,46.79298486500005],[10.685960645000023,46.793301076000034],[10.685270935000062,46.79340122900004],[10.68491401600005,46.79351544300005],[10.684442882000042,46.79368676400003],[10.683900365000056,46.79381525500003],[10.683457786000076,46.79341550600003],[10.68330074100004,46.79308714000007],[10.682958099000075,46.79277305100004],[10.682444135000026,46.79211632000005],[10.684043133000046,46.79117405300008],[10.684542820000047,46.790046189000066],[10.683229357000073,46.789546502000064],[10.685856282000032,46.78849002100003],[10.685784898000065,46.78776666500005],[10.683429232000037,46.786029659000064],[10.682620215000043,46.78503028500006],[10.680883209000058,46.78445921400004],[10.678598926000063,46.78462577700003],[10.67557701100003,46.78448300900004],[10.672793041000034,46.78362640300003],[10.671893282000042,46.78234878300003],[10.669961483000066,46.78110417400006],[10.673387907000063,46.78000962200008],[10.675767368000038,46.77877230300004],[10.674256410000055,46.77554788500004],[10.671636766000063,46.775204648000056],[10.670241069000042,46.77379303300006],[10.67144679100005,46.77186962700006],[10.670538502000056,46.76846898900004],[10.674286153000025,46.766119271000036],[10.673902931000043,46.76445179000007],[10.675475884000036,46.76025984800003],[10.674405126000067,46.75927832000008],[10.67211489500005,46.757939874000044],[10.669913894000047,46.756660913000076],[10.668486217000066,46.75493580400007],[10.66676110800006,46.75347838400006],[10.664798052000037,46.75276454600004],[10.662864740000032,46.75246711300008],[10.66122886100004,46.75181276200004],[10.658403251000038,46.750563545000034],[10.65691608800006,46.75044457100006],[10.655369438000037,46.750563545000034],[10.653138693000074,46.748659976000056],[10.650134624000032,46.745804623000026],[10.647665933000042,46.74428771600003],[10.647249527000042,46.740629295000076],[10.645792108000023,46.738011888000074],[10.641776767000067,46.736138062000066],[10.639456793000022,46.73610831900004],[10.637107075000074,46.73524576400007],[10.634965560000069,46.733461169000066],[10.633121478000021,46.73182528900003],[10.631426112000042,46.730427356000064],[10.628957421000052,46.72846430000004],[10.627262055000074,46.72679867800008],[10.625536946000068,46.72519254200006],[10.622979025000063,46.72430024400006],[10.620688794000046,46.722991540000066],[10.618636509000055,46.72174232300006],[10.61521603400007,46.72067156600008],[10.614650912000059,46.72049310600005],[10.613847844000077,46.71977926800008],[10.61322323500002,46.71900594300007],[10.611200693000058,46.717697239000074],[10.608166880000056,46.71615059000004],[10.606084852000038,46.71430650700006],[10.604597689000059,46.71341421000005],[10.604062310000074,46.71275985800003],[10.603170012000021,46.712164993000044],[10.602396687000066,46.71180807300004],[10.601682849000042,46.710975262000034],[10.600969011000075,46.71020193700008],[10.59864903600004,46.70776299000005],[10.597042900000076,46.70502661000006],[10.593652168000062,46.702944581000054],[10.591332194000074,46.70324201400007],[10.588833760000057,46.70377739200006],[10.586394812000037,46.70443174400003],[10.584610216000044,46.70484815000003],[10.577590806000046,46.70627582700007],[10.571352256000068,46.70662744100008],[10.566117442000063,46.70478335900003],[10.56186415600007,46.70311773700007],[10.555201665000027,46.701809033000075],[10.551900163000028,46.70255261500006],[10.54850943100007,46.702671588000044],[10.543219759000067,46.70236812500008],[10.543203724000023,46.702278017000026],[10.524368269000036,46.70105735800007],[10.52259299700006,46.69937217200004],[10.520138892000034,46.696581526000045],[10.518878609000069,46.693997875000036],[10.520881478000035,46.69226243600008],[10.522442054000066,46.69016136600004],[10.524108348000027,46.68798456600007],[10.527361932000076,46.68467210400007],[10.530382514000053,46.68076828800008],[10.53390855400005,46.67566886100008],[10.538690683000027,46.669215079000026],[10.540465690000076,46.667110867000076],[10.541732842000044,46.66612793100006],[10.542875158000072,46.66455228700005],[10.543774170000063,46.66201404900005],[10.54438545000005,46.66074274300007],[10.545789894000052,46.660798072000034],[10.548285770000064,46.66128439800008],[10.551951289000044,46.66116043100004],[10.556449911000072,46.65998484800008],[10.559528986000032,46.658234073000074],[10.56185068700006,46.656419259000074],[10.564265098000021,46.65408304700003],[10.56570434400004,46.651611539000044],[10.566185706000056,46.64959891700005],[10.566412747000072,46.646252418000074],[10.56656194900006,46.64394714900004],[10.566721865000034,46.64201322000008],[10.566786808000074,46.64052637900005],[10.567168797000022,46.63881229900005],[10.566481104000047,46.63741006400005],[10.569780669000068,46.63587887500006],[10.571919867000076,46.63525511700004],[10.573293526000043,46.63427036100006],[10.573789542000043,46.63277758100003],[10.57513508900007,46.63082731900005],[10.59906752300003,46.63777643700007],[10.600762904000021,46.63892974700008],[10.607204677000027,46.641545791000055],[10.607773658000042,46.641614925000056],[10.616732151000065,46.64545506400003],[10.616736358000026,46.64545304200004],[10.61681962700004,46.64549255600008],[10.623541499000055,46.64868185100005],[10.630331471000034,46.654157284000064],[10.630335700000046,46.65416069300005],[10.631768931000067,46.65531625400007],[10.63571616400003,46.658978078000075],[10.638196046000076,46.66109522900007],[10.640079764000063,46.66229132900003],[10.641177779000031,46.663351900000066],[10.643046821000041,46.66405892500006],[10.645057981000036,46.66476387500006],[10.647362240000064,46.66575810900008],[10.649178263000067,46.667052882000064],[10.65077232300007,46.66805728400004],[10.652017212000032,46.66926240200007],[10.653980019000073,46.670701748000056],[10.654863256000056,46.671989162000045],[10.655190212000036,46.67204536400004],[10.65559799700003,46.67234094600008],[10.65587111900004,46.67250798300006],[10.656102975000067,46.67260812100005],[10.656402649000029,46.67278827200005],[10.656560084000034,46.67301997900006],[10.65671696000004,46.67320669600008],[10.657015202000025,46.67358035500007],[10.657155531000058,46.673947302000045],[10.65738806500002,46.674443405000034],[10.657652158000076,46.67484905500004],[10.657818305000035,46.67504463600005],[10.657984874000022,46.67528070900005],[10.658084038000027,46.67545026200003],[10.658340284000076,46.67597301700005],[10.658630161000076,46.67649978500003],[10.658929727000043,46.676675431000035],[10.659006803000068,46.67672705100006],[10.659376914000063,46.67697492700006],[10.659626915000047,46.677106293000065],[10.660181106000039,46.67737723500005],[10.660630852000054,46.677573196000026],[10.66130327600007,46.677621929000054],[10.662000203000048,46.67767030200008],[10.662372951000066,46.67764688700004],[10.662655959000062,46.67757527800006],[10.662930810000034,46.677530785000044],[10.663536598000064,46.67743198200003],[10.663818926000033,46.67736488000003],[10.66466517200007,46.67735256800006],[10.665322188000061,46.677352005000046],[10.665545613000063,46.67738925000003],[10.666151494000076,46.67750641900005],[10.666525510000042,46.67757746700005],[10.667123631000038,46.67768124500003],[10.668061976000047,46.677793559000065],[10.669065974000034,46.67770241900007],[10.669672072000026,46.677693574000045],[10.670045384000048,46.67771512300004],[10.670394746000056,46.677755019000074],[10.67066789300003,46.67784102600007],[10.671073989000035,46.67805108200008],[10.671291593000035,46.678137898000045],[10.67197124200004,46.67818196300004],[10.672419662000038,46.67812141100006],[10.673158598000043,46.67804760900003],[10.673531482000044,46.67802865500005],[10.674155256000063,46.67798353000006],[10.675035382000033,46.67793014800003],[10.675625264000075,46.67789901000003],[10.67609901700007,46.67786507100004],[10.676313917000073,46.67796991600005],[10.676529655000024,46.67810174700003],[10.676778261000038,46.67831859000006],[10.67713546300007,46.678664334000075],[10.677324740000074,46.678918045000046],[10.677566279000075,46.67914399000006],[10.677890399000034,46.67947671700006],[10.67818892200006,46.679800819000036],[10.678326764000076,46.67991881900008],[10.678586848000066,46.68014146100006],[10.678835691000074,46.68028630100008],[10.679059652000035,46.680472003000034],[10.679269367000074,46.680616695000026],[10.679276781000056,46.68062180700008],[10.679724090000036,46.68089422400004],[10.680114563000075,46.68107298000007],[10.68048720400003,46.68125649500007],[10.680701871000053,46.68156382400008],[10.681026304000056,46.681905537000034],[10.681200488000059,46.68214596300004],[10.681466152000041,46.68254253600003],[10.68175745800005,46.68281723800004],[10.682133872000065,46.68308355500005],[10.682181129000071,46.68311699100008],[10.68261998500003,46.68332652400005],[10.682902187000025,46.68343936600007],[10.683101904000068,46.683580420000055],[10.683275404000028,46.68379835500008],[10.68342465400002,46.68399864700007],[10.683574304000047,46.68418543400003],[10.68371522700005,46.684354350000035],[10.683822701000054,46.68457775500008],[10.684079815000075,46.684803457000044],[10.684445416000074,46.68515355400007],[10.684628007000072,46.68532185500004],[10.684794123000074,46.68548589900007],[10.685157725000067,46.68587652100007],[10.68535778000006,46.68608056200003],[10.685548829000027,46.68625773700006],[10.685738687000025,46.68647542600007],[10.685939400000052,46.68664795800004],[10.686461630000053,46.687013739000065],[10.68687688700004,46.68712011000008],[10.687283649000051,46.68716360800005],[10.687573747000044,46.68724032400007],[10.687857123000072,46.687258642000074],[10.688221935000058,46.68713626600004],[10.688837395000064,46.686978690000046],[10.689451613000074,46.68680762900004],[10.689866535000021,46.68669350700003],[10.690549154000053,46.68643593500008],[10.691180326000051,46.68620611800003],[10.69150294900004,46.686120353000035],[10.692010714000048,46.68599585000004],[10.692873353000039,46.685771600000066],[10.693388041000048,46.685633489000054],[10.693870332000074,46.68550485600008],[10.694534349000037,46.68533303100003],[10.69483318500005,46.685297106000064],[10.695430994000048,46.685229750000076],[10.695855610000024,46.685164960000066],[10.696353115000022,46.68522508700005],[10.69648569900005,46.68524111200003],[10.697050575000048,46.685322728000074],[10.697357663000048,46.68536766900007],[10.698031283000034,46.68552866300007],[10.698354065000046,46.68560486600006],[10.698969121000061,46.685748724000064],[10.699649486000055,46.68596810500003],[10.70033967300003,46.685953348000055],[10.70087052100007,46.68591395800007],[10.701552063000065,46.685962319000055],[10.701809354000034,46.68603498700003],[10.701958637000075,46.68607776400006],[10.70239405600006,46.686174779000055],[10.702851270000053,46.68615897400008],[10.703158021000036,46.68614090900007],[10.703596494000067,46.68628287100006],[10.704110365000076,46.68650920400006],[10.704391134000048,46.68662651400007],[10.704698050000047,46.68674343400005],[10.704996622000067,46.68682897900004],[10.705385311000043,46.68689518100007],[10.705726478000031,46.68695759000008],[10.706305555000029,46.68704794900003],[10.706818961000067,46.68710328600008],[10.707632123000053,46.68720364400008],[10.708188015000076,46.687258341000074],[10.708543963000068,46.68727102400004],[10.708810688000028,46.687253541000075],[10.709167670000056,46.68722120900003],[10.709475349000058,46.687180614000056],[10.710081754000043,46.68712655300004],[10.711119196000027,46.68703004400004],[10.711801043000037,46.68698384400005],[10.712091030000067,46.68695250600007],[10.712755113000071,46.686861570000076],[10.713046059000021,46.68683471400004],[10.71342047500002,46.68681110800003],[10.713977569000065,46.68674876500006],[10.714583958000048,46.686591186000044],[10.714957623000032,46.68651808900006],[10.715291258000036,46.68644559100005],[10.715613174000055,46.686467761000074],[10.715963401000067,46.686480507000056],[10.716311073000043,46.686515789000055],[10.716618534000077,46.686520175000055],[10.716981975000067,46.68653722000005],[10.717448276000027,46.68649872100008],[10.717837289000045,46.68649738000005],[10.718203326000037,46.68651888100004],[10.718560049000075,46.68650452300005],[10.718826012000022,46.68643753100008],[10.719100494000031,46.686329912000076],[10.71940922300007,46.68627127500008],[10.719741666000061,46.68613578500003],[10.72031652000004,46.68593815200006],[10.720748688000072,46.68575166200003],[10.72139893700006,46.68535490100004],[10.72169916300004,46.685080398000025],[10.721957294000049,46.68497301800005],[10.722013600000025,46.68520165800004],[10.72211214500004,46.68544766000008],[10.722268180000071,46.68562530100007],[10.722532583000032,46.68579231000007],[10.723053760000028,46.68611744200007],[10.72338423900004,46.686305953000044],[10.723631477000026,46.68654971400008],[10.723863210000047,46.686717213000065],[10.723952551000025,46.68690485600007],[10.723934567000072,46.68716161200007],[10.724155936000045,46.68749125700003],[10.724221200000045,46.68769276200004],[10.724602634000064,46.68788950100003],[10.725073836000035,46.688107383000045],[10.725354357000072,46.68829214200008],[10.72560969500006,46.68848177900003],[10.725764947000073,46.688839417000054],[10.725706223000032,46.689074290000065],[10.725528716000042,46.68945494600007],[10.72534431300005,46.68969621400004],[10.725243488000046,46.689918222000074],[10.725091304000046,46.690298496000025],[10.725029819000042,46.69060090600004],[10.724863630000073,46.690823899000065],[10.724544724000054,46.691179687000044],[10.724403490000043,46.69133930700008],[10.724285602000066,46.69153907300006],[10.724177315000077,46.69178369100007],[10.724099913000032,46.692099840000026],[10.72393842300005,46.69254774800004],[10.723896764000074,46.69270165300003],[10.723785553000027,46.69311252000006],[10.72366515400006,46.69354180900007],[10.723623717000066,46.69378092000005],[10.723469960000045,46.694215212000074],[10.723259086000041,46.69470436100005],[10.723844629000041,46.69537949900007],[10.724288105000028,46.69585428800008],[10.724495085000058,46.69601315800003],[10.724749650000035,46.69638279900005],[10.72499762600006,46.696802035000076],[10.725226381000027,46.69720806200007],[10.725488541000061,46.69763608300008],[10.725635233000048,46.69790385500005],[10.725718250000057,46.698123089000035],[10.725732871000048,46.698325357000044],[10.725721872000065,46.69877549700004],[10.725701800000024,46.69917177700006],[10.725599037000052,46.699641299000064],[10.725580442000023,46.70010955300006],[10.72551992600006,46.700339952000036],[10.725403616000051,46.70051269600003],[10.725277439000024,46.700735087000055],[10.72516795200005,46.70091672700005],[10.724958179000055,46.70115837700007],[10.724757637000039,46.701381887000025],[10.724573925000072,46.701569146000054],[10.724281206000057,46.70190203900006],[10.723896185000058,46.70226332100003],[10.72350345700005,46.70266521600007],[10.723335262000035,46.70285223900004],[10.723185148000027,46.70301649000004],[10.72296704200005,46.70325376200003],[10.722674164000068,46.70358215300007],[10.722348387000068,46.70395603700007],[10.722005527000022,46.70438417300005],[10.721654164000029,46.70477643900006],[10.721494558000074,46.70497682900003],[10.721235250000063,46.70517871900006],[10.721060993000037,46.705329832000075],[10.720842502000039,46.70550410900006],[10.720659049000062,46.70570035700007],[10.720450133000043,46.70586552900005],[10.72029933400006,46.70598475000003],[10.719832286000042,46.70636525000003],[10.719431960000065,46.70673574600005],[10.719164915000022,46.70687475200003],[10.718964392000032,46.70704875500007],[10.718763867000064,46.70722275800006],[10.718413421000037,46.70761949900003],[10.71818763500005,46.70784787700006],[10.717928508000057,46.70800475900006],[10.717560836000075,46.708271264000075],[10.71735198700003,46.70844089000008],[10.717143240000041,46.70858801500003],[10.71700091300005,46.70879263900008],[10.716806481000049,46.70904140700003],[10.716691309000055,46.70918876200005],[10.71669504600004,46.70922920300006],[10.716721377000056,46.709543789000065],[10.716795177000051,46.70980816600007],[10.71685863700003,46.71008169700008],[10.716974292000032,46.710273449000056],[10.71709646000005,46.71054159900007],[10.717252332000044,46.710944235000056],[10.71737485400007,46.71117188200003],[10.717472324000028,46.71140890400005],[10.71755461400005,46.711605657000064],[10.717544703000044,46.711911787000076],[10.717566605000059,46.71226693700004],[10.717554396000025,46.71268109500005],[10.717644450000023,46.712967726000045],[10.717683425000075,46.71316512800007],[10.717775034000056,46.71339773900007],[10.71781429500004,46.71360413700006],[10.717879998000058,46.71381913700003],[10.717951955000046,46.71402504400004],[10.718100500000048,46.71424779900008],[10.718280754000034,46.714542074000065],[10.71844601500004,46.714827574000026],[10.718576398000039,46.71501910400008],[10.718673817000024,46.71530562300006],[10.718705725000063,46.715512131000025],[10.718762575000028,46.715631614000074],[10.718820519000076,46.71575339100008],[10.718975856000043,46.71595804400005],[10.719075818000022,46.71611853200005],[10.719240332000027,46.71635454600005],[10.719437481000057,46.71663956500004],[10.719618591000028,46.71685732900005],[10.719857147000027,46.717132726000045],[10.720154046000061,46.71751973800008],[10.720284972000059,46.71770225800003],[10.720473135000077,46.71792183800005],[10.72049815500003,46.717951037000034],[10.720664193000061,46.71810603000006],[10.720888066000043,46.71830515000005],[10.721127187000036,46.71849504100004],[10.721498120000035,46.718817940000065],[10.72199508600005,46.718963451000036],[10.722708620000049,46.71915519600003],[10.723054036000065,46.719266987000026],[10.723289585000032,46.71934443400005],[10.723594233000028,46.71943433800004],[10.724182707000068,46.719627958000046],[10.724565200000029,46.71974818500007],[10.724796436000076,46.72002368200003],[10.724827907000076,46.72005563600004],[10.72521566100005,46.72044933400008],[10.725387861000058,46.72069422200008],[10.725445384000068,46.72088234300003],[10.72543659400003,46.721093962000054],[10.725417992000075,46.72130573000004],[10.725332646000027,46.72152750300006],[10.725231807000057,46.72177650900005],[10.72522211100005,46.721934145000034],[10.725137739000047,46.72208390800006],[10.725004744000046,46.72224790400003],[10.724810567000077,46.72249381600005],[10.724630415000036,46.72261207300005],[10.724579040000037,46.72264579800003],[10.724278541000047,46.72286631400004],[10.723985457000026,46.72303722000004],[10.723800609000023,46.72324249300004],[10.723616965000076,46.723434248000046],[10.723531012000024,46.72359195400003],[10.723406780000062,46.72381989100006],[10.723404772000038,46.72419339800007],[10.723399336000057,46.724395677000075],[10.723392795000052,46.724639051000054],[10.72336630500007,46.72503992500003],[10.723371513000075,46.725408823000066],[10.723619843000051,46.72545007900004],[10.723977051000077,46.72549419400008],[10.724507518000053,46.72558519300003],[10.72482317500004,46.72563443100006],[10.725510272000065,46.725763561000065],[10.72636572700003,46.72593964300006],[10.726997480000023,46.72605160000006],[10.72737070200003,46.72613596000008],[10.728042420000065,46.72626980700005],[10.728837780000049,46.72643327900005],[10.729409897000039,46.72664961800007],[10.729425941000045,46.726654600000074],[10.72990724300007,46.72680408900004],[10.730071255000041,46.72694353800006],[10.730104837000056,46.72697209000006],[10.730285405000075,46.72714484800008],[10.730467754000074,46.72732207900003],[10.730666455000062,46.72749906200005],[10.730938883000022,46.727679429000034],[10.731386030000067,46.727875150000045],[10.731867515000033,46.72814684400004],[10.732471787000065,46.72842117700003],[10.733084485000063,46.72860088500005],[10.733325187000048,46.72870973200003],[10.73323192600003,46.72891363200006],[10.733097740000062,46.72909115400006],[10.733037470000056,46.72930355300008],[10.733027358000072,46.72960068800006],[10.733057150000036,46.73019869900003],[10.733028999000055,46.73062209900007],[10.732985606000057,46.730901739000046],[10.732909653000036,46.73110987600006],[10.732902685000056,46.73113757200008],[10.732849429000055,46.731349273000035],[10.732722737000074,46.73153118100004],[10.732523273000027,46.73171419000005],[10.73223030400004,46.73204260600005],[10.732230083000047,46.73204280600004],[10.731763598000043,46.73246364500005],[10.731487220000076,46.73269731400006],[10.731435364000049,46.73281509100008],[10.731308790000071,46.73323098100008],[10.731239948000052,46.73345700800007],[10.731113994000054,46.73391788500004],[10.73101936200004,46.73420729900005],[10.731059750000043,46.73439567500003],[10.73111614800007,46.73470080300007],[10.731185756000059,46.735239715000034],[10.731227154000067,46.73545957400006],[10.731301403000032,46.735683436000045],[10.731239628000026,46.73590035700005],[10.731130086000064,46.736158499000055],[10.731180237000046,46.73639622400003],[10.731319277000068,46.73665060400003],[10.731499153000073,46.736953862000064],[10.731648687000074,46.73712708800008],[10.732069110000054,46.73758419400008],[10.732314557000052,46.73781926800007],[10.732415999000068,46.73791642000003],[10.732620565000047,46.73814730700008],[10.73295168200002,46.73849776900005],[10.732999014000029,46.73854270700008],[10.733198920000063,46.738732508000055],[10.733570692000058,46.73910035100005],[10.734165567000048,46.739613302000066],[10.734477416000061,46.73992355400003],[10.734684547000029,46.74013190000005],[10.73484112400007,46.74034551200003],[10.735064660000035,46.74050411200005],[10.735510779000037,46.74081682500008],[10.735501208000073,46.74102845600004],[10.73545815700004,46.74134408900005],[10.735463021000044,46.74177598700004],[10.735395003000065,46.74200200400003],[10.73536113700004,46.74219600500004],[10.735243282000056,46.742373282000074],[10.735123885000064,46.74275756800006],[10.735023105000039,46.74295708300008],[10.734913953000046,46.74312522800005],[10.73474630100003,46.743433750000065],[10.734577398000056,46.74372879200007],[10.734335418000057,46.74409243700006],[10.734259505000068,46.74425107800005],[10.734273790000032,46.74446684700007],[10.734379575000048,46.74470372800005],[10.734510861000047,46.74494472200007],[10.734617900000046,46.745118587000036],[10.734625452000046,46.74530296100005],[10.73481408300006,46.745520586000055],[10.73520159800006,46.74596918000003],[10.735507765000023,46.746356010000056],[10.735606440000026,46.746498504000044],[10.735662490000038,46.74674063800006],[10.735670624000022,46.746943001000034],[10.735707870000056,46.74741490500003],[10.73568227900006,46.74758628200004],[10.735646536000047,46.74787480500004],[10.735678201000042,46.74827479800007],[10.735883541000021,46.748451671000055],[10.736124195000059,46.74863250700008],[10.73635532700007,46.74882248700004],[10.73653599000005,46.74899523400006],[10.736710014000039,46.74919057900007],[10.736799895000047,46.749364703000026],[10.73683774500006,46.74962455100007],[10.736839790000033,46.74963857900008],[10.736822768000025,46.74987282200004],[10.736422718000028,46.749977888000046],[10.73611307300007,46.75009508000005],[10.735719516000074,46.750467908000076],[10.735620700000027,46.750561520000076],[10.735444224000048,46.750672190000046],[10.735354975000064,46.750772537000046],[10.73522464000007,46.750994999000056],[10.735127165000051,46.75114496800006],[10.735031037000056,46.75136241200005],[10.735068470000044,46.75163632600004],[10.73504953400004,46.75182671400006],[10.735024547000023,46.752077962000044],[10.735004678000053,46.75247873700005],[10.734918748000041,46.75275902200008],[10.734733796000057,46.75316679900004],[10.734671680000076,46.75342422400007],[10.73449490400003,46.75383187700004],[10.734349833000067,46.75413105700005],[10.734124407000024,46.75462944100008],[10.733965522000062,46.755135815000074],[10.734054302000061,46.75557586700006],[10.73405602400004,46.755584413000065],[10.734059729000023,46.75582734100004],[10.733873895000045,46.75620813200004],[10.733692338000026,46.756773345000056],[10.733517178000056,46.757333962000075],[10.73348738900006,46.75752790000007],[10.733518450000076,46.75769453100003],[10.73353088400006,46.75776122600007],[10.733628033000059,46.758034235000025],[10.733754775000023,46.75823480100007],[10.733902596000064,46.75863303400007],[10.734007782000049,46.75897791600005],[10.734096513000054,46.75934554600008],[10.734024908000038,46.75956261700003],[10.73389820400007,46.759924513000044],[10.733621597000024,46.760410172000036],[10.73357881100003,46.760512532000064],[10.733525063000059,46.76064111900007],[10.733298834000038,46.76101352200004],[10.733005952000042,46.76147692700005],[10.732779030000074,46.76231280800005],[10.732643789000065,46.76279182300004],[10.732538441000031,46.76297790600006],[10.732355650000045,46.76348014000007],[10.732249960000047,46.76370672500008],[10.731764081000051,46.76399756100005],[10.731113752000056,46.76436737800003],[10.730577328000038,46.76469047100005],[10.730388523000045,46.76480132000006],[10.729844441000068,46.765115526000045],[10.729332743000043,46.76539324300006],[10.72918876600005,46.76572839600004],[10.729139799000052,46.765801845000055],[10.728961482000045,46.766069308000056],[10.728863673000035,46.76621027600004],[10.72863495300004,46.76642971700005],[10.72849541100004,46.76664781000005],[10.728479262000064,46.76666687300008],[10.728376793000052,46.766787848000035],[10.728348701000073,46.76682101500006],[10.728294100000028,46.76703332500006],[10.728258656000037,46.76718238600006],[10.728247924000073,46.767227509000065],[10.728199824000058,46.767412723000064],[10.72825283700007,46.76763690700005],[10.728340159000027,46.76791006900004],[10.72843595300003,46.76819210200006],[10.72860012700005,46.76859009400005],[10.728805887000021,46.76898295800004],[10.72888402600006,46.76922476000004],[10.728923831000031,46.76970112600003],[10.729317800000047,46.769938155000034],[10.729412935000028,46.77014820200003],[10.729518117000055,46.77049308800008],[10.72957487800005,46.77091070100005],[10.729635314000063,46.771085275000075],[10.72982926800006,46.77126233100006],[10.730081320000068,46.77143850700003],[10.730393813000035,46.77178925700008],[10.730522450000024,46.77204829300007],[10.730818200000044,46.77241279300006],[10.73100671900005,46.77267542300007],[10.731376410000053,46.77297130800008],[10.73192896200004,46.77325092500007],[10.732212752000066,46.77331862400007],[10.732473243000072,46.77347666900005],[10.73264209000007,46.77363610000003],[10.73281117700003,46.77385402400006],[10.732897717000071,46.77405070000003],[10.732993015000034,46.77434173600005],[10.732846831000074,46.77450593900005],[10.732467429000053,46.774826662000066],[10.73211752700007,46.775173936000044],[10.73190274500007,46.775343675000045],[10.73152645700003,46.77573634400005],[10.731140252000046,46.776075164000076],[10.730839394000043,46.77637119500008],[10.73076405200004,46.77644533000006],[10.730379468000024,46.77686061800006],[10.730193925000037,46.777059964000046],[10.730043885000043,46.77722116800004],[10.730007957000055,46.77725654100004],[10.730001556000047,46.77726284200003],[10.729830382000046,46.77743138100004],[10.729783131000033,46.77747487000005],[10.729651446000048,46.777596075000076],[10.72963290000007,46.777666090000025],[10.729595204000077,46.777808410000034],[10.729686869000034,46.77829299000007],[10.72978900000004,46.77851643000008],[10.730029456000068,46.77907075500008],[10.730236514000069,46.779553590000035],[10.730291617000034,46.779791239000076],[10.730338044000064,46.78021800700003],[10.730416927000022,46.78048229500007],[10.730388795000067,46.78077969900005],[10.730352139000047,46.78111773000006],[10.730789663000053,46.78148458600003],[10.731169184000066,46.78182981900005],[10.731329964000054,46.78204337100004],[10.731295234000072,46.78246686600005],[10.731282277000048,46.782624551000026],[10.731216557000039,46.78279653300007],[10.731091224000068,46.78320340100004],[10.731045425000048,46.78353707000008],[10.731018161000065,46.783861459000036],[10.731019691000029,46.78403692300003],[10.731032004000042,46.78429321900006],[10.731093616000067,46.78450377100006],[10.731212138000046,46.78465046700006],[10.731255317000034,46.78477130500005],[10.731308267000031,46.78494149200003],[10.731310763000067,46.78512144100006],[10.731306033000067,46.78538249400003],[10.731254166000042,46.785756752000054],[10.73109632400002,46.786299101000054],[10.730966653000053,46.78664753800007],[10.730913198000053,46.78689582900006],[10.730737157000021,46.78733046100007],[10.730624196000065,46.78756165300007],[10.730495147000056,46.787878582000076],[10.730283918000055,46.78808426200004],[10.729873206000036,46.78842794800005],[10.729357083000025,46.78895771200007],[10.728842821000057,46.78954594100003],[10.728687914000034,46.789746268000044],[10.728532950000044,46.789996091000035],[10.728410302000043,46.79015543200006],[10.728346058000056,46.79032289000003],[10.728325185000074,46.79056618800007],[10.728339754000046,46.790711575000046],[10.728384160000076,46.79115475400005],[10.72847893900007,46.79194076500005],[10.72851761100003,46.79238114900005],[10.728563574000077,46.792614437000054],[10.728462560000025,46.79306593000007],[10.72842421100006,46.79330049300006],[10.728397359000041,46.79363837300008],[10.728140556000028,46.79377724200003],[10.727666167000052,46.79425687200006],[10.727304698000069,46.79463130200003],[10.727182422000055,46.79477713700004],[10.727010734000032,46.79499121300006],[10.726897264000058,46.79518191200003],[10.726654237000048,46.79557255100008],[10.726491496000051,46.79583598800008],[10.726250501000038,46.79646957700004],[10.726179251000076,46.79670013500004],[10.726100298000063,46.79690562300004],[10.726092304000076,46.79692643000004],[10.726119918000052,46.797123999000064],[10.726116692000062,46.79748402100006],[10.726064267000027,46.79771429500005],[10.725488989000041,46.79785796200008],[10.724748143000056,46.79804911800005],[10.72405857900003,46.798230498000066],[10.723783213000047,46.79830214100008],[10.72317560700003,46.798459783000055],[10.72258781000005,46.79863977700006],[10.721429275000048,46.79899453100006],[10.721013710000022,46.799113274000035],[10.720871634000048,46.79917840600007],[10.720718512000076,46.79925080500004],[10.72054726600004,46.79933177300006],[10.720305866000047,46.79949289100006]]);

		const catchment = L.polygon(longlat, {color: '#3388ff', fillColor: '#000000', fillOpacity: 0.2}).addTo(map);

		// Add map layers.
		L.control.layers(basemap, {}, {'collapsed': false, position: 'topleft'}).addTo(map)

		Object.keys(opts.data).map(function(k) {
			let item = opts.data[k];

			let marker = L.marker([item.Latitude, item.Longitude]).addTo(map);

			marker.on('click', function() {
				$("#s"+item.ID).modal('toggle');
			});

			marker.bindTooltip(document.getElementById("s"+item.ID).getAttribute("data-name"))
			mapMarkers[item.ID] = marker
		});

		map.fitBounds(catchment.getBounds());

		L.Control.DownloadArea = L.Control.extend({
			onAdd: function(map) {
				const div = L.DomUtil.create('div', 'leaflet-control-layers leaflet-control-layers-expanded');
				div.appendChild(document.getElementById(opts.dlMapAreaEl));
				return div;
			},

			onRemove: function(map) {},
		});

		L.control.downloadArea = function(opts) {
			return new L.Control.DownloadArea(opts);
		}

		L.control.downloadArea({position: 'topleft'}).addTo(map);
		//L.control.attribution({position: 'topright'}).addTo(map);
		L.control.zoom({position: "topright"}).addTo(map);
		L.control.scale({position: "topright"}).addTo(map);
	}

	function maxMeasurementSelected() {
		const selectedOptions = $(opts.measurementEl + ' option:selected');
		return selectedOptions.length > maxMeasurement
	}

	// toggleDownload enables the download botton if at least one station and
	// one measurement was selected. Moreover it checks if the time range
	// selected is not ore than a year. Otherwise it will be disable it.
	function toggleDownload() {
		if ($(opts.sDateEl).val() == "" || $(opts.eDateEl).val() == "") {
			$(opts.submitEl).attr("disabled", "disabled");
			return
		}

		if ($(opts.stationEl).val() == null || $(opts.stationEl).val().length < 1) {
			$(opts.submitEl).attr("disabled", "disabled");
			$(opts.codeEl).attr("disabled", "disabled");
			return
		}

		if ($(opts.measurementEl).val() == null || $(opts.measurementEl).val().length < 1) {
			$(opts.submitEl).attr("disabled", "disabled");
			$(opts.codeEl).attr("disabled", "disabled");
			return
		}

		$(opts.submitEl).removeAttr("disabled");
		$(opts.codeEl).removeAttr("disabled");
	}

	// ToggleOptions enables or disables an option. arr is an array of objects
	// with these keys:
	// 	[{ el: "id of select", data: "set of items"}]
	function toggleOptions(arr) {
		arr.forEach(function(item) {
			$(item.el).children('option').map(function() {
				if (item.data.size === 0) {
					$(this).prop('disabled', false);
					return
				}
				if (item.data.has(this.value)) {
					$(this).prop('disabled', false);
					return
				}

				$(this).prop('disabled', true);
				$(this).prop('selected', false);
			});

			$(item.el).multiselect('refresh')
		});
	}

	// filterByMeasurements filters the global opts.data object by the given
	// measurements and returns an object with the following keys:
	// 	stations - set of stations
	//	landuse - set of landuses
	function filterByMeasurements(names) {
		const stations = new Set();
		const landuse = new Set();

		if (! Array.isArray(names)) {
				return {stations, landuse}
		}

		opts.data.forEach(function(o) {
			if (! Array.isArray(o.Measurements)) {
				return {stations, landuse}
			}

			let result = names.every(function(val) {
				return o.Measurements.indexOf(val) >= 0
			});
			if (result) {
				stations.add(o.ID);
				landuse.add(o.Landuse);
			}
		});

		return {stations, landuse};
	}

	// filterByStations filters the global opts.data object by the given
	// stations and returns an object with the following keys:
	// 	measurements - set of measurements
	//	landuse - set of landuses
	function filterByStations(stations) {
		let measurements = new Set();
		const landuse = new Set();

		if (! Array.isArray(stations)) {
			return {measurements, landuse};
		}

		opts.data.forEach(function(o, i) {
			if (stations.indexOf(o.ID) < 0) {
				return;
			}

			if (Array.isArray(o.Measurements)) {
				if (measurements.size === 0) {
					o.Measurements.forEach(m => measurements.add(m));
					return;
				}
				measurements = new Set(o.Measurements.filter(x => measurements.has(x)));
			}
			landuse.add(o.Landuse);
		});

		return {measurements, landuse};
	}

	// filterByLanduse filters the global opts.data object by the given landuses
	// and returns an object with the following keys:
	// 	measurements - set of measurements
	//	stations - set of stations
	function filterByLanduse(landuse) {
		const measurements = new Set();
		const stations = new Set();

		if (! Array.isArray(landuse)) {
			return {measurements, stations};
		}

		opts.data.forEach(function(o) {
			if (landuse.indexOf(o.Landuse) < 0) {
				return;
			}

			if (Array.isArray(o.Measurements)) {
				o.Measurements.forEach(m => measurements.add(m));
			}
			stations.add(o.ID);
		});

		return {measurements, stations};
	}

	function toggleMapMarkers() {
		const blue = L.icon({
    			iconUrl: '/static/third_party/leaflet/images/marker-icon.png',
    			iconRetinaUrl: '/static/third_party/leaflet/images/marker-icon-2x.png',
    			iconSize: [25, 41],
   			iconAnchor: [12, 41],
    			popupAnchor: [1, -34],
    			tooltipAnchor: [16, -28],
    			shadowUrl: '/static/third_party/leaflet/images/marker-shadow.png',
    			shadowSize: [41, 41],
		});

		const yellow = L.icon({
    			iconUrl: '/static/third_party/leaflet/images/marker-icon-yellow.png',
    			iconRetinaUrl: '/static/third_party/leaflet/images/marker-icon-2x-yellow.png',
    			iconSize: [25, 41],
   			iconAnchor: [12, 41],
    			popupAnchor: [1, -34],
    			tooltipAnchor: [16, -28],
    			shadowUrl: '/static/third_party/leaflet/images/marker-shadow.png',
    			shadowSize: [41, 41],
		});

		$(opts.stationEl).children('option').map(function() {
			let el = $(this)
			let m = mapMarkers[el.val()];

			if (el.prop('selected')) {
				m.setIcon(yellow);
			} else {
				m.setIcon(blue);
			}
		});
	}

	function handleUpdateMeasurement() {
		const m = filterByMeasurements($(opts.measurementEl).val());

		toggleOptions([
			{el: opts.stationEl, data: m.stations},
			{el: opts.landuseEl, data: m.landuse}
		]);
		toggleDownload();
		toggleMapMarkers();
	}

	function handleUpdateStation() {
		const s = filterByStations($(opts.stationEl).val());

		toggleOptions([
			{el: opts.measurementEl, data: s.measurements},
			{el: opts.landuseEl, data: s.landuse}
		]);
		toggleDownload();
		toggleMapMarkers();
	}

	function handleUpdateLanduse() {
		const l = filterByLanduse($(opts.landuseEl).val());

		toggleOptions([
			{el: opts.measurementEl, data: l.measurements},
			{el: opts.stationEl, data: l.stations}
		]);
		toggleDownload();
		toggleMapMarkers();
	}

	let stdOptions = [];

	function hideStdOptions() {
		stdOptions = [];
		$(opts.measurementEl).children('option').map(function() {
			let el = $(this);
			let v = el.val();

			if (v.endsWith("_std")) {
				stdOptions.push(el.remove());
			}
		});
	}

	// Hide all standard deviations.
	hideStdOptions();

	// Initialize UI elements
	$(opts.measurementEl).multiselect({
		maxHeight: 400,
		buttonWidth: "100%",
		enableFiltering: true,
		filterBehavior: "both",
		enableRegexFiltering: true,
		enableCaseInsensitiveFiltering: true,
		includeSelectAllOption: true,
		onChange: function() {
			handleUpdateMeasurement();
		},
		onSelectAll: function() {
			handleUpdateMeasurement();
		},
		onDeselectAll: function() {
			handleUpdateMeasurement();
			$(opts.measurementEl).popover('hide');
		},
	});

	$('#showStd').on('change', function() {
		if (this.checked) {
			stdOptions.forEach(function(o) {
				$(opts.measurementEl).append(o);
			});

			const options = $("#measurements option");
			options.detach().sort(function(a,b) {
   				let at = $(a).text();
    				let bt = $(b).text();
    				return (at > bt)?1:((at < bt)?-1:0);
			});
			options.appendTo(opts.measurementEl);
		} else {
			hideStdOptions();
		}
		$(opts.measurementEl).multiselect("rebuild");
		handleUpdateStation();
	});

	$(opts.stationEl).multiselect({
		maxHeight: 400,
	 	buttonWidth: "100%",
		enableFiltering: true,
		filterBehavior: "both",
		enableRegexFiltering: true,
		enableFullValueFiltering: true,
		enableCaseInsensitiveFiltering: true,
		includeSelectAllOption: true,
		onChange: function() {
			handleUpdateStation();
		},
		onSelectAll: function() {
			handleUpdateStation();
		},
		onDeselectAll: function() {
			handleUpdateStation();
		},
	});

	$(opts.landuseEl).multiselect({
		maxHeight: 400,
		buttonWidth: "100%",
		enableFiltering: true,
		filterBehavior: "both",
		enableRegexFiltering: true,
		enableFullValueFiltering: true,
		enableCaseInsensitiveFiltering: true,
		includeSelectAllOption: true,
		onChange: function() {
			handleUpdateLanduse();
		},
		onSelectAll: function() {
			handleUpdateLanduse();
		},
		onDeselectAll: function() {
			handleUpdateLanduse();
		},
	});

	$(opts.elevationEl).ionRangeSlider({
		skin: "round",
		type: "double",
		min: getMinElevation(),
		max: getMaxElevation(),
		grid: true,
		onChange: function(data) {
			const stations = new Set();
			const landuse = new Set();
			const measurements = new Set();

			opts.data.forEach(function(item) {
				let marker = mapMarkers[item.ID]
				if (item.Elevation >= data.from && item.Elevation <= data.to) {
					stations.add(item.ID);
					landuse.add(item.Landuse);
					if (Array.isArray(item.Measurements)) {
						item.Measurements.forEach(m => measurements.add(m));
					}

					marker.setOpacity(1.0);
				} else {
					marker.setOpacity(0.4);
				}
			});

			toggleOptions([
				{el: opts.measurementEl, data: measurements},
				{el: opts.stationEl, data: stations},
				{el: opts.landuse, data: landuse},
			]);
		}
	 });


	$(opts.dateEl).datepicker({
		todayHighlight: true,
		format: 'yyyy-mm-dd',
		endDate: new Date()
	}).on('hide', function() {
		toggleDownload();

		if ($(opts.sDateEl).val() == "" || $(opts.eDateEl).val() == "") {
			$(opts.dateEl).popover('show')
			return
		}

		$(opts.sDateEl).popover('show');
	}).on('show', function() {
		$(opts.dateEl).popover('hide');
	});

	$(opts.submitLongBtnEl).click(function(e){
		$(opts.formatEl).val('long');

		var startDate = new Date($(opts.sDateEl).val());
		startDate.setHours(0,0,0,0);

		var endDate = new Date($(opts.eDateEl).val());
		endDate.setFullYear(endDate.getFullYear() - 1);
		endDate.setHours(0,0,0,0);

		if (maxMeasurementSelected() || (startDate < endDate)) {
			$(opts.infoModalEl).modal();
			return
		}

		$(opts.formEl).submit();
	});

	$(opts.submitWideBtnEl).click(function(e){
		$(opts.formatEl).val('wide');

		var startDate = new Date($(opts.sDateEl).val());
		startDate.setHours(0,0,0,0);

		var endDate = new Date($(opts.eDateEl).val());
		endDate.setFullYear(endDate.getFullYear() - 1);
		endDate.setHours(0,0,0,0);

		if (maxMeasurementSelected() || (startDate < endDate)) {
			$(opts.infoModalEl).modal();
			return
		}

		$(opts.formEl).submit();
	});

	$(opts.infoModalEl).find('.btn-primary').click(function(){
		$(opts.formEl).submit();
		$(opts.infoModalEl).modal('hide');
	});


	// Scroll to top button appear
	$(document).on('scroll', function() {
		var scrollDistance = $(this).scrollTop();
		if (scrollDistance > 100) {
			$(opts.scrollToTopEl).fadeIn();
		} else {
			$(opts.scrollToTopEl).fadeOut();
		}
	});

	// Smooth scrolling using jQuery easing
	$(document).on('click', 'a'+opts.scrollToTopEl, function(e) {
		const $anchor = $(this);
		$('html, body').stop().animate({
			scrollTop: ($($anchor.attr('href')).offset().top)
		}, 1000, 'easeInOutExpo');
		e.preventDefault();
	});

	loadMap();
}
